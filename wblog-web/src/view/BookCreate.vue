<template>
  <div class="book-box">
    <div class="book-main">
      <ul class="book-nav">
        <li>
          <a href="/"><span>主页</span></a>
        </li>
        <li class="book-nav-sep"><span>/</span></li>
        <li>
          <span class="book-label">{{ bookID ? "编辑图书" : "创建图书" }}</span>
        </li>
      </ul>
      <div class="editor-box-wrap">
        <div class="book-area">
          <el-form
              ref="formValidate"
              :model="formValidate"
              :rules="ruleInline"
              :label-width="80"
          >
            <el-form-item label="图书名称" prop="bookName">
              <Input
                  v-model="formValidate.bookName"
                  placeholder="请输入图书名称"
                  style="width: 400px"
              ></Input>
            </el-form-item>
            <el-form-item label="封面图片" prop="bookPic">
              <div
                  class="book-img"
                  :style="{
                  width: imgWidth + 2 + 'px',
                  height: imgHeight + 2 + 'px',
                }"
              >
                <img :src="coverURL" />
              </div>
              <el-upload
                  action=""
                  accept="image/*"
                  :show-upload-list="false"
                  :before-upload="beforeUpload"
                  :name="'upFile'"
                  :format="['jpg', 'jpeg', 'png']"
                  :on-format-error="onFormatError"
              >
                <Button type="ghost" icon="ios-cloud-upload-outline"
                >上传封面图片</Button
                >
              </el-upload>
              <el-dialog v-model="uploaderVisible" width="400">
                <div slot="header" style="color: #f60; text-align: center">
                  <p id="uploader-pop-title">编辑封面图片</p>
                  <p id="uploader-pop-subheading">调整尺寸和位置</p>
                </div>
                <div id="avatarUploader"></div>
                <div slot="footer">
                  <el-button type="primary" long @click="onUpload">保存</el-button>
                </div>
              </el-dialog>
            </el-form-item>
            <el-form-item label="图书简介" prop="content">
              <div>
                <md-editor
                    :value="formValidate.content"
                    :user="user"
                    @save="onContentSave"
                    @change="onContentChange"
                ></md-editor>
              </div>
            </el-form-item>
            <el-form-item :label-width="0">
              <el-button
                  size="large"
                  v-if="isMounted"
                  type="primary"
                  @click="onSubmit"
              >{{ bookID ? "保存图书" : "创建图书" }}</el-button
              >
            </el-form-item>
          </el-form>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import ErrorCode from "@/constant/ErrorCode";
import Editor from "@/components/Editor";
import { config } from "@/utils/config";
import axios from "axios";
import {createBook, updateBook} from "@/utils/apiConfig";

export default {
  name:'BookCreate',
  data() {
    return {
      book:'',
      user:{},
      isMounted: false,
      bookID: (this.book && this.book.id) || undefined,
      coverURL: (this.book && this.book.coverURL) || "",
      uploadURL: config.uploadURL,
      file: null,
      uploaderVisible: false,
      croppie: null,
      imgWidth: 188,
      imgHeight: 238,
      formValidate: {
        bookName: (this.book && this.book.name) || "",
        content:
            (this.book && (this.book.content || this.book.htmlContent)) || "",
      },
      ruleInline: {
        bookName: [
          { required: true, message: "请输入图书名称", trigger: "blur" },
        ],
        content: [
          { required: true, message: "请输入图书简介", trigger: "blur" },
        ],
      },
    };
  },
  mounted() {
    this.isMounted = true;
  },
  head() {
    return {
      title: this.bookID ? "编辑图书" : "创建图书",
      link: [
        { rel: "stylesheet", href: "/styles/editor/simplemde.min.css" },
        { rel: "stylesheet", href: "/styles/croppie/croppie.min.css" },
      ],
      script: [{ src: "/javascripts/croppie/croppie.min.js" }],
    };
  },
  methods: {
    onFormatError() {
      this.$message.error({
        duration: config.messageDuration,
        closable: true,
        content: "不是有效的图片格式",
      });
    },
    beforeUpload(file) {
      let self = this;
      this.file = file;
      if (file.size > config.sizeLimit) {
        this.$message.error({
          duration: config.messageDuration,
          closable: true,
          content: "图片大小要小于" + config.sizeLimitTip,
        });
        return;
      }
      this.uploaderVisible = !this.uploaderVisible;
      let avatarUploader = document.getElementById("avatarUploader");
      avatarUploader.innerHTML = "";
      this.croppie = null;
      let reader = new FileReader();
      reader.addEventListener("load", function () {
        setTimeout(() => {
          let opts = {
            url: reader.result,
            boundary: {
              width: self.imgWidth + 80,
              height: self.imgHeight + 80,
            },
            viewport: {
              width: self.imgWidth,
              height: self.imgHeight,
              type: "square",
            },
          };
          self.croppie = new window.Croppie(avatarUploader, opts);
        }, 200);
      });
      reader.readAsDataURL(file);
      return false;
    },
    onUpload() {
      let self = this;
      this.croppie &&
      this.croppie.result("blob").then(function (blob) {
        let form = new FormData();
        form.append("upFile", blob, self.file.name);
        let config = {
          headers: {
            "Content-Type": "multipart/form-data",
          },
        };
        axios.post(self.uploadURL, form, config).then((res) => {
          let result = res.data;
          if (result.errNo === ErrorCode.SUCCESS) {
            self.coverURL = result.data.url;
            self.uploaderVisible = false;
          } else {
            self.$message.error({
              duration: config.messageDuration,
              closable: true,
              content: result.msg,
            });
          }
        });
      });
    },
    onContentChange(content) {
      this.formValidate.content = content;
    },
    onContentSave() {
      this.onSubmit();
    },
    onSubmit() {
      this.$refs["formValidate"].validate((valid) => {
        if (valid) {
          let self = this;
          let func = this.bookID ?  updateBook : createBook;
          func({
            body: {
              id: this.bookID,
              name: this.formValidate.bookName,
              content: this.formValidate.content,
              coverURL: this.coverURL,
            },
          })
              .then((res) => {
                if (res.errNo === ErrorCode.ERROR) {
                  self.$message.error({
                    duration: config.messageDuration,
                    closable: true,
                    content: res.msg,
                  });
                } else if (res.errNo === ErrorCode.LOGIN_TIMEOUT) {
                  location.href =
                      "/signin?ref=" + encodeURIComponent(location.href);
                } else if (res.errNo === ErrorCode.SUCCESS) {
                  setTimeout(function () {
                    let userID = self.user.id;
                    location.href = `/user/${userID}/books/`;
                  }, 500);
                }
              })
              .catch((err) => {
                self.$message.error({
                  duration: config.messageDuration,
                  closable: true,
                  content: err.message || err.msg,
                });
              });
        }
      });
      return false;
    },
  },
  components: {
    "md-editor": Editor,
  },
};
</script>

<style>
@import "../assets/styles/book/edit.css";
</style>
